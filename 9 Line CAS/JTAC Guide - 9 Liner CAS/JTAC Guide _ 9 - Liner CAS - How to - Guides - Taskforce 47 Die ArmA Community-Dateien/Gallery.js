var Gallery={};(function(){var b=0;var c=["ms","moz","webkit","o"];for(var a=0;a<c.length&&!window.requestAnimationFrame;++a){window.requestAnimationFrame=window[c[a]+"RequestAnimationFrame"];window.cancelRequestAnimationFrame=window[c[a]+"CancelRequestAnimationFrame"]}if(!window.requestAnimationFrame){window.requestAnimationFrame=function(h,e){var d=new Date().getTime();var f=Math.max(0,16-(d-b));var g=window.setTimeout(function(){h(d+f)},f);b=d+f;return g}}if(!window.cancelAnimationFrame){window.cancelAnimationFrame=function(d){clearTimeout(d)}}}());Gallery.Album={};Gallery.Album.Dialog=Class.extend({_createdCallbacks:[],_descriptionError:null,_dialog:null,_dialogContainer:null,_saveCallbacks:[],_proxy:null,_titleError:null,_updatedCallbacks:[],_validationCallbacks:[],init:function(){this._proxy=new WCF.Action.Proxy({success:$.proxy(this._success,this)})},_cancel:function(){this._dialogContainer.wcfDialog("close")},_hideDescriptionError:function(){if(this._descriptionError){this._descriptionError.hide();this._dialog.find('textarea[name="description"]').parents("dl").removeClass("formError")}},_hideTitleError:function(){if(this._titleError){this._titleError.hide();this._dialog.find('input[name="title"]').parents("dl").removeClass("formError")}},_save:function(){var e=false;var d=this._dialog.find('input[name="title"]').val();if(!d.length){e=true;this._showTitleError(WCF.Language.get("wcf.global.form.error.empty"))}else{if(d.length>255){e=true;this._showTitleError(WCF.Language.get("gallery.album.title.error.tooLong"))}else{this._hideTitleError()}}var b=this._dialog.find('textarea[name="description"]').val();if(b.length>65535){e=true;this._showDescriptionError(WCF.Language.get("gallery.album.description.error.tooLong"))}else{this._hideDescriptionError()}for(var a in this._validationCallbacks){if(!this._validationCallbacks[a](this._dialogContainer)){e=true}}if(!e){this._dialogContainer.find("button").disable();var c={description:b,title:d};for(var a in this._saveCallbacks){c=this._saveCallbacks[a](c)}if(this._dialogContainer.data("albumID")){this._proxy.setOption("data",{actionName:"update",className:"gallery\\data\\album\\AlbumAction",objectIDs:[this._dialogContainer.data("albumID")],parameters:{data:c}})}else{this._proxy.setOption("data",{actionName:"create",className:"gallery\\data\\album\\AlbumAction",parameters:{data:c}})}this._proxy.sendRequest()}},_showDialog:function(d,c){if(this._dialog===null){this._dialogContainer=$('<div id="albumDialog" />').data("__api",this).appendTo(document.body);this._dialog=$("<div />").appendTo(this._dialogContainer);var b=$('<div class="formSubmit" />').appendTo(this._dialogContainer);var e=$('<button class="buttonPrimary">'+WCF.Language.get("wcf.global.button.save")+"</button>").appendTo(b);var a=$("<button>"+WCF.Language.get("wcf.global.button.cancel")+"</button>").appendTo(b);a.click($.proxy(this._cancel,this));e.click($.proxy(this._save,this))}else{this._dialogContainer.find("button").enable()}this._dialogContainer.data("albumID",c);this._dialog.html(d);this._dialogContainer.wcfDialog({title:WCF.Language.get(c?"gallery.album.edit":"gallery.album.add")});this._dialogContainer.wcfDialog("render");this._dialog.find('input[name="title"]').focus()},_showDescriptionError:function(a){if(this._descriptionError===null){this._descriptionError=$('<small class="innerError" />').hide();this._dialog.find('textarea[name="description"]').after(this._descriptionError);this._dialog.find('textarea[name="description"]').parents("dl").addClass("formError")}this._descriptionError.show().text(a)},_showTitleError:function(a){if(this._titleError===null){this._titleError=$('<small class="innerError" />').hide();this._dialog.find('input[name="title"]').after(this._titleError);this._dialog.find('input[name="title"]').parents("dl").addClass("formError")}this._titleError.show().text(a)},_success:function(c,d,b){switch(c.actionName){case"create":this._cancel();new WCF.System.Notification().show();for(var a in this._createdCallbacks){this._createdCallbacks[a](c.returnValues)}break;case"getDialog":this._showDialog(c.returnValues.template,c.returnValues.albumID);break;case"update":this._cancel();new WCF.System.Notification().show();for(var a in this._updatedCallbacks){this._updatedCallbacks[a](this._dialogContainer)}break}},registerCallback:function(a,b){if(a!="created"&&a!="save"&&a!="updated"&&a!="validate"){console.debug('[Gallery.Album.Dialog] Unknown event "'+a+'"');return}if(!$.isFunction(b)){console.debug("[Gallery.Album.Dialog] Given callback is invalid.");return}switch(a){case"created":this._createdCallbacks.push(b);break;case"updated":this._updatedCallbacks.push(b);break;case"save":this._saveCallbacks.push(b);break;case"validate":this._validationCallbacks.push(b);break}},show:function(a){var b=[];if(a){b.push(a)}this._proxy.setOption("data",{actionName:"getDialog",className:"gallery\\data\\album\\AlbumAction",objectIDs:b});this._proxy.sendRequest()}});Gallery.Album.InlineEditor=WCF.InlineEditor.extend({_dialog:null,_permissions:{},_redirectURL:"",_execute:function(a,c){if(!this._validate(a,c)){return false}var d=$("#"+a).data("albumID");switch(c){case"delete":var b=this._redirectURL;WCF.System.Confirmation.show(WCF.Language.get("gallery.album.delete.confirmMessage"),function(e){if(e==="confirm"){new WCF.Action.Proxy({autoSend:true,data:{actionName:"delete",className:"gallery\\data\\album\\AlbumAction",objectIDs:[d]},success:function(g,h,f){new WCF.System.Notification(WCF.Language.get("gallery.album.delete.success")).show(function(){window.location=b})}})}});break;case"edit":this.getDialog().show(d);break}},_getPermission:function(a){if(this._permissions[a]){return this._permissions[a]}return 0},_getTriggerElement:function(a){return a.find(".jsAlbumInlineEditor")},_registerAlbumDialogCallbacks:function(){this._dialog.registerCallback("updated",$.proxy(this._updateAlbumData,this))},_setOptions:function(){this._options=[{label:WCF.Language.get("gallery.album.delete"),optionName:"delete"},{optionName:"divider"},{label:WCF.Language.get("wcf.global.button.edit"),optionName:"edit",isQuickOption:true}]},_updateAlbumData:function(a){var b=$(".boxHeadline > h1 > .badge");$(".boxHeadline > h1").text(a.find('input[name="title"]').val()+(b?" ":""));if(b){$(".boxHeadline > h1").append(b)}$(".boxHeadline > p").text(a.find('textarea[name="description"]').val())},_validate:function(a,b){switch(b){case"delete":if(!this._getPermission("canDeleteAlbum")){return false}return true;break;case"edit":if(!this._getPermission("canEditAlbum")){return false}return true;break}return false},getDialog:function(){if(this._dialog===null){this._dialog=new Gallery.Album.Dialog();this._registerAlbumDialogCallbacks()}return this._dialog},setPermission:function(a,b){this._permissions[a]=b},setPermissions:function(a){for(var b in a){this.setPermission(b,a[b])}},setRedirectURL:function(a){this._redirectURL=a},});Gallery.Album.Share=WCF.Message.Share.Content.extend({_albumID:0,init:function(a){this._albumID=a;this._super()},_click:function(d){d.preventDefault();var a=$(d.currentTarget);var b=a.prop("href");var c=b.hashCode();if(this._cache[c]===undefined){var f=false;if(this._dialog===null){this._dialog=$("<div />").hide().appendTo(document.body);f=true}else{this._dialog.empty()}var e=$('<fieldset><legend><label for="__sharePermalink">'+WCF.Language.get("wcf.message.share.permalink")+"</label></legend></fieldset>").appendTo(this._dialog);$('<input type="text" id="__sharePermalink" class="long" readonly="readonly" />').attr("value",b).appendTo(e);var e=$('<fieldset><legend><label for="__shareBBCode">'+WCF.Language.get("wcf.message.share.permalink.bbcode")+"</label></legend></fieldset>").appendTo(this._dialog);$('<input type="text" id="__shareBBCode" class="long" readonly="readonly" />').attr("value","[album]"+this._albumID+"[/album]").appendTo(e);this._cache[c]=this._dialog.html();if(f){this._dialog.wcfDialog({title:WCF.Language.get("wcf.message.share")})}else{this._dialog.wcfDialog("open")}}else{this._dialog.html(this._cache[c]).wcfDialog("open")}this._enableSelection()}});Gallery.Category={};Gallery.Category.MarkAllAsRead=Class.extend({_proxy:null,init:function(){this._proxy=new WCF.Action.Proxy({success:$.proxy(this._success,this)});$(".markAllAsReadButton").click($.proxy(this._click,this))},_click:function(){this._proxy.setOption("data",{actionName:"markAllAsRead",className:"gallery\\data\\category\\GalleryCategoryAction"});this._proxy.sendRequest()},_success:function(b,c,a){$(".nestedCategoryList").find(".badge.badgeUpdate").hide();$(".galleryImageList .galleryNewImageBagde").hide();$("#mainMenu .active .badge").hide()}});Gallery.Image={};Gallery.Image.Browser=Class.extend({_ckeditor:null,_dialog:null,_isOpen:false,_redactor:null,init:function(a,b){this._ckeditor=a||null;this._redactor=b||null;this._dialog=null;this._isOpen=false},open:function(){if(this._isOpen){return false}this._isOpen=true;if(this._dialog===null){new WCF.Action.Proxy({autoSend:true,data:{actionName:"getImageBrowser",className:"gallery\\data\\image\\UserImageAction",objectIDs:[WCF.User.userID]},success:$.proxy(this._initImageBrowser,this)})}else{this._dialog.wcfDialog("open")}},_initImageBrowser:function(b,c,a){this._dialog=$("<div />").hide().html(b.returnValues.template).appendTo(document.body);this._dialog.wcfDialog({onClose:$.proxy(function(){this._isOpen=false},this),title:WCF.Language.get("gallery.image.browser")});new Gallery.Image.Browser.AlbumList.Loader(this);new Gallery.Image.Browser.ImageList.Loader(this);new Gallery.Image.Browser.Search.Loader(this);WCF.DOMNodeInsertedHandler.addCallback("Gallery.Image.Browser."+(this._ckeditor?this._ckeditor.name:this._redactor.$textarea.wcfIdentify()),$.proxy(this._domNodeInserted,this));$(window).trigger("resize");this._dialog.wcfDialog("render")},_insertBBCode:function(b){var a=$(b.currentTarget).data("bbcode");if(this._ckeditor){this._ckeditor.insertText(a)}else{this._redactor.wutil.insertDynamic(a)}},_domNodeInserted:function(){this._dialog.find(".jsGalleryImageBrowserInsertAlbum").removeClass("jsGalleryImageBrowserInsertAlbum").click($.proxy(this._insertBBCode,this));var a=this;this._dialog.find(".jsGalleryImageBrowserInsertImage").removeClass("jsGalleryImageBrowserInsertImage").each(function(b,d){var c=$(d);$dropdownMenu=WCF.Dropdown.getDropdownMenu(c.wcfIdentify());$dropdownMenu.find("li").click($.proxy(a._insertBBCode,a))})}});Gallery.Image.Browser.Loader=Class.extend({_actionName:"loadImages",_cache:{},_imageBrowser:null,_list:null,_pagination:null,_pageNo:1,_pages:0,_previousPageNo:1,_proxy:null,init:function(c,a,b){this._actionName="loadImages";this._cache={};this._imageBrowser=c;this._list=$("#"+a);this._pagination=$("#"+b);this._pageNo=1;this._pages=0;this._proxy=new WCF.Action.Proxy({success:$.proxy(this._success,this)});this._previousPageNo=1},_showPage:function(a,b){if(b&&b.activePage){if(!b.template){this._previousPageNo=this._pageNo}this._pageNo=b.activePage}if(this._cache[this._pageNo]||(b&&b.template)){this._cache[this._previousPageNo]=this._list.children().detach();if(b&&b.template){this._list.html(b.template)}else{this._list.append(this._cache[this._pageNo])}}else{this._loadItems()}},_getParameters:function(){return{data:{pageNo:this._pageNo}}},_loadItems:function(){this._proxy.setOption("data",{actionName:this._actionName,className:"gallery\\data\\image\\UserImageAction",parameters:this._getParameters()});this._proxy.sendRequest()},_success:function(b,c,a){this._showPage(null,{activePage:b.returnValues.pageNo,template:b.returnValues.template})}});Gallery.Image.Browser.AlbumList={};Gallery.Image.Browser.AlbumList.Loader=Gallery.Image.Browser.Loader.extend({init:function(a){this._super(a,"galleryImageBrowserAlbumList","galleryImageBrowserAlbumPagination");this._actionName="loadAlbums";if(this._pagination.data("pages")){this._pagination.wcfPages({maxPage:this._pagination.data("pages")}).on("wcfpagesswitched",$.proxy(this._showPage,this))}}});Gallery.Image.Browser.ImageList={};Gallery.Image.Browser.ImageList.Loader=Gallery.Image.Browser.Loader.extend({init:function(a){this._super(a,"galleryImageBrowserImageList > ol","galleryImageBrowserImageListPagination");if(this._pagination.data("pages")>1){this._pagination.wcfPages({maxPage:this._pagination.data("pages")}).on("wcfpagesswitched",$.proxy(this._showPage,this))}}});Gallery.Image.Browser.Search={};Gallery.Image.Browser.Search.Handler=WCF.Search.Base.extend({_searchLoader:null,init:function(b){this._super("#galleryImageBrowserImageSearchInput",null,[],false,true);this._delay=500;this._searchLoader=b;var a=this._searchInput.parent().removeClass("dropdown");WCF.Dropdown.removeDropdown(a.wcfIdentify())},_keyUp:function(a){switch(a.which){case $.ui.keyCode.UP:case $.ui.keyCode.DOWN:return;break}this._super(a)},_queryServer:function(a){this._proxy.setOption("data",{actionName:"loadImages",className:"gallery\\data\\image\\UserImageAction",parameters:this._getParameters(a)});this._proxy.sendRequest()},_getParameters:function(a){a.data.pageNo=1;return a},_success:function(b,c,a){this._searchLoader.handleSearchResult(b)},_clearList:function(a){if(a){this._searchInput.val("")}}});Gallery.Image.Browser.Search.Loader=Gallery.Image.Browser.Loader.extend({_searchString:"",init:function(a){this._super(a,"galleryImageBrowserImageSearchResultList","galleryImageBrowserImageSearchResultPagination");this._list.hide();new Gallery.Image.Browser.Search.Handler(this)},handleSearchResult:function(a){if(this._pages>1){this._pagination.wcfPages("destroy")}this._pageNo=1;this._pages=a.returnValues.pages;this._searchString=a.returnValues.searchString;this._pagination.empty();if(this._pages>1){this._pagination.wcfPages({maxPage:this._pages}).on("wcfpagesswitched",$.proxy(this._showPage,this))}this._list.empty().hide().next("p").remove();if(this._pages){this._list.html(a.returnValues.template).show();WCF.DOMNodeInsertedHandler.execute()}else{$('<p class="info">'+a.returnValues.errorMessage+"</p>").insertAfter(this._list)}},_getParameters:function(){var a=this._super();a.data.searchString=this._searchString;return a}});Gallery.Image.Delete=WCF.Action.Delete.extend({_redirectURL:"",init:function(b,a,c){this._super(b,a);this._redirectURL=c},_success:function(b,d,a){var c=new WCF.System.Notification(WCF.Language.get("gallery.image.delete.success"));c.show($.proxy(function(){window.location=this._redirectURL},this))}});Gallery.Image.AlbumNavigation=Class.extend({_activeImage:null,_imageList:null,init:function(){this._activeImage=$(".gallerySidebarBoxImageNavigation").find("li.active");this._imageList=$("#galleryAlbumImageNavigation");var a=-this._activeImage.position().left+this._activeImage.outerWidth(true);var b=-this._activeImage.outerWidth(true)*(this._imageList.children().size()-3);if(a>0){a=0}else{if(a<b){a=b}}this._imageList.css("left",a);if(!a){$(".galleryNavigationArrowPrevious").addClass("disabled").children(".pointer").removeClass("pointer")}else{if(a==b){$(".galleryNavigationArrowNext").addClass("disabled").children(".pointer").removeClass("pointer")}}$(".galleryNavigationArrowPrevious").click($.proxy(this._showPreviousImages,this));$(".galleryNavigationArrowNext").click($.proxy(this._showNextImages,this))},_showPreviousImages:function(f){var d=$(f.currentTarget);if($(f.currentTarget).hasClass("disabled")){return}var a=parseInt(this._imageList.css("left"));var c=this._activeImage.outerWidth(true);var e=a+3*c;while(e>0){e-=c}if(e!=a){var b=$(".galleryNavigationArrowNext");if(b.hasClass("disabled")){b.removeClass("disabled");b.children(".icon").addClass("pointer")}}this._imageList.animate({left:e},500,function(){if(e!=a+3*c){d.addClass("disabled");d.children(".pointer").removeClass("pointer")}})},_showNextImages:function(f){var d=$(f.currentTarget);if($(f.currentTarget).hasClass("disabled")){return}var a=parseInt(this._imageList.css("left"));var c=this._activeImage.outerWidth(true);var e=a-3*c;while(e<-c*(this._imageList.children().size()-3)){e+=c}if(e!=a){var b=$(".galleryNavigationArrowPrevious");if(b.hasClass("disabled")){b.removeClass("disabled");b.children(".icon").addClass("pointer")}}this._imageList.animate({left:e},500,function(){if(e!=a-3*c){d.addClass("disabled");d.children(".pointer").removeClass("pointer")}})}});Gallery.Image.InlineEditor=WCF.InlineEditor.extend({_environment:"list",_permissions:{},_redirectURL:"",_updateHandler:null,setRedirectURL:function(b,a){this._redirectURL=b;this._environment=a||"list"},setUpdateHandler:function(a){this._updateHandler=a},_setOptions:function(){this._options=[{label:WCF.Language.get("gallery.image.enable"),optionName:"enable"},{label:WCF.Language.get("gallery.image.disable"),optionName:"disable"},{label:WCF.Language.get("gallery.image.trash"),optionName:"trash"},{label:WCF.Language.get("gallery.image.restore"),optionName:"restore"},{label:WCF.Language.get("gallery.image.delete"),optionName:"delete"},{optionName:"divider"},{label:WCF.Language.get("wcf.global.button.edit"),optionName:"edit",isQuickOption:true}]},_show:function(d){var e=$(d.currentTarget).data("elementID");var b=null;if(!this._dropdowns[e]){b=this._getTriggerElement(this._elements[e]).addClass("dropdownToggle").parent().addClass("dropdown").end();this._dropdowns[e]=$('<ul class="dropdownMenu" />').insertAfter(b)}this._super(d);if(b!==null){WCF.Dropdown.initDropdown(b,true);var c=b.parent().wcfIdentify();WCF.Dropdown.registerCallback(c,$.proxy(this._toggleDropdown,this));this._toggleDropdown(c,"open")}for(var a in this._elements){this._elements[a].removeClass("jsGalleryImageShowDetails")}this._elements[e].addClass("jsGalleryImageShowDetails");return false},_hide:function(a){this._super(a);this._elements[a].removeClass("jsGalleryImageShowDetails")},_toggleDropdown:function(a,b){WCF.Dropdown.getDropdown(a).parents(".messageOptions").toggleClass("forceOpen")},_getTriggerElement:function(a){return a.find(".jsImageInlineEditor")},_validate:function(a,c){var b=$("#"+a).data("objectID");switch(c){case"delete":if(!this._getPermission("canDeleteImage")){return false}return(this._updateHandler.getValue(b,"isDeleted"));break;case"restore":if(!this._getPermission("canRestoreImage")){return false}return(this._updateHandler.getValue(b,"isDeleted"));break;case"trash":if(!this._getPermission("canTrashImage")){return false}return !(this._updateHandler.getValue(b,"isDeleted"));break;case"enable":if(!this._getPermission("canEnableImage")){return false}if(this._updateHandler.getValue(b,"isDeleted")){return false}return(this._updateHandler.getValue(b,"isDisabled"));break;case"disable":if(!this._getPermission("canEnableImage")){return false}if(this._updateHandler.getValue(b,"isDeleted")){return false}return !(this._updateHandler.getValue(b,"isDisabled"));break;case"edit":return true;break}return false},_execute:function(a,c){if(!this._validate(a,c)){return false}switch(c){case"disable":case"enable":this._updateImage(a,c,{isDisabled:(c==="enable"?0:1)});break;case"delete":var b=this;WCF.System.Confirmation.show(WCF.Language.get("gallery.image.delete.confirmMessage"),function(d){if(d==="confirm"){b._updateImage(a,c,{deleted:1})}});break;case"edit":window.location=this._getTriggerElement($("#"+a)).prop("href");break;case"restore":this._updateImage(a,c,{isDeleted:0});break;case"trash":var b=this;WCF.System.Confirmation.show(WCF.Language.get("gallery.image.trash.confirmMessage"),function(d){if(d==="confirm"){b._updateImage(a,c,{isDeleted:1,reason:$("#wcfSystemConfirmationContent").find("textarea").val()})}},{},$("<fieldset><dl><dt>"+WCF.Language.get("gallery.image.trash.reason")+'</dt><dd><textarea cols="40" rows="4" /></dd></dl></fieldset>'));break}},_updateImage:function(a,d,e){if(d==="delete"){var c=this;var b=this._elements[a].data("objectID");new WCF.Action.Proxy({autoSend:true,data:{actionName:"delete",className:"gallery\\data\\image\\ImageAction",objectIDs:[b]},success:function(f){if(c._redirectURL){window.location=c._redirectURL}else{window.location.reload()}}})}else{this._updateData.push({data:e,elementID:a,optionName:d});this._proxy.setOption("data",{actionName:d,className:"gallery\\data\\image\\ImageAction",objectIDs:[this._elements[a].data("objectID")],parameters:{data:e}});this._proxy.sendRequest()}},_updateState:function(){if(this._environment=="image"&&this._updateData.length==1&&this._updateData[0].optionName=="trash"&&!this._getPermission("canViewDeletedImage")){this._notification.show($.proxy(function(){window.location=this._redirectURL},this));return}this._notification.show();for(var c=0,b=this._updateData.length;c<b;c++){var a=this._updateData[c];this._updateHandler.update($("#"+a.elementID).data("objectID"),a.data)}},_getPermission:function(a){if(this._permissions[a]){return this._permissions[a]}return 0},setPermission:function(a,b){this._permissions[a]=b},setPermissions:function(a){for(var b in a){this.setPermission(b,a[b])}}});Gallery.Image.Like=WCF.Like.extend({_getContainers:function(){return $(".galleryImageContainer")},_getObjectID:function(a){return this._containers[a].data("objectID")},_getWidgetContainer:function(a){return $("#imageButtonContainer")},_buildWidget:function(b,a,d,c,e){var f=this._getWidgetContainer(b);if(this._canLike){f.prepend(d).prepend(a);d.find("a").addClass("button");a.find("a").addClass("button")}if(e){e.appendTo($(".galleryImageContainer"));e.addClass("messageFooterNote marginTop")}$(".galleryImageHeadline > h1").append(c)},_setActiveState:function(a,b,c){a=a.find(".button").removeClass("active");b=b.find(".button").removeClass("active");if(c==1){a.addClass("active")}else{if(c==-1){b.addClass("active")}}},_addWidget:function(a,b){}});Gallery.Image.Handler=Class.extend({_activeImageID:"",_callbacks:{addImage:[],removeImage:[]},_dataHandlers:{},_errorMessage:null,_image:null,_imageContainer:null,_images:{},_initialData:{},_maxUserImageCount:0,_maxDescriptionLength:0,_maxInputVars:0,_proxy:null,_redirectURL:"",_saveButton:null,_saveRequestCount:0,_scrollEffect:null,_thumbnailListContainer:null,_thumbnailAreaSelector:null,_tmpHash:"",_uploadHandler:null,_uploadWarning:null,_userImageCount:0,init:function(d,c,b,f,e,a){this._tmpHash=d;this._userImageCount=c;this._maxUserImageCount=b;this._maxDescriptionLength=f;this._maxInputVars=e;this._saveRequestCount=0;this._callbacks={addImage:[],removeImage:[]};this._initialData={};this._proxy=new WCF.Action.Proxy({success:$.proxy(this._success,this)});this._thumbnailListContainer=$("#thumbnailListContainer");this._imageContainer=$("#imageContainer");this._saveButton=$("#saveButton").click($.proxy(this._save,this));this._thumbnailAreaSelector=new Gallery.Image.ThumbnailAreaSelector(this);if(this._tmpHash){this._uploadHandler=new Gallery.Image.Upload(this,a);if(this._userImageCount<this._maxUserImageCount){this._thumbnailListContainer.show()}else{this._uploadHandler.hideUploadButton();this._uploadWarning=$(".jsGalleryUploadWaning")}}},_getImageIDs:function(){var b=[];for(var a in this._images){b.push(a)}return b},_getRequestData:function(){var g=[];var f={};var e=0;for(var a in this._images){var c=0;var b=this._images[a].getData();if(!b.__useCoordinates){b.latitude=0;b.longitude=0;b.location=""}for(var d in b){if(d.substr(0,2)=="__"){delete b[d]}else{if($.isArray(b[d])){c+=b[d].length}else{if($.isPlainObject(b[d])){c+=$.getLength(b[d])}else{c++}}}}if(e+$.getLength(b)>this._maxInputVars-150){g.push(f);f={};e=0}f[a]=b;e+=c}g.push(f);return g},_handleSavedImageData:function(e){if(e.thumbnailImageIDs!==undefined&&e.thumbnailImageIDs.length){new WCF.System.Notification(WCF.Language.get("gallery.image.upload.info.thumbnailGeneration"),"info").show(undefined,5000);var b=new Gallery.Image.ThumbnailGenerator();var d=0;for(var a in e.thumbnailImageIDs){b.generateThumbnails(e.thumbnailImageIDs[a],$.proxy(function(){d++;if(d==e.thumbnailImageIDs.length){this._saveRequestCount--;if(!this._saveRequestCount){window.location=this._redirectURL}}},this))}}else{if(e.errors!==undefined){for(var c in this._images){this.getImage(c).setErrors(e.errors[c]||{})}this.setActiveImage(this.getActiveImage());this._saveButton.enable()}else{this._saveRequestCount--;if(!this._saveRequestCount){window.location=this._redirectURL}}}},_save:function(){this._saveButton.disable();this.setActiveImage(this.getActiveImage());if(this.validate()){if(this._errorMessage!==null){this._errorMessage.hide()}this._sendRequests()}else{this.setActiveImage(this.getActiveImage());if(this._errorMessage===null){this._errorMessage=$('<p class="error" />').text(WCF.Language.get(this._tmpHash?"gallery.image.upload.error.markedImages":"wcf.global.form.error")).hide().insertBefore("#thumbnailListContainer");this._scrollEffect=new WCF.Effect.Scroll()}this._scrollEffect.scrollTo(this._errorMessage);this._errorMessage.show();this._saveButton.enable()}},_sendRequests:function(){var b=this._getRequestData();this._saveRequestCount=b.length;for(var a in b){this._proxy.setOption("data",{actionName:"saveImageData",className:"gallery\\data\\image\\ImageAction",objectIDs:Object.keys(b[a]),parameters:{data:b[a],isEdit:this._tmpHash?0:1}});this._proxy.sendRequest()}},_success:function(c,d,b){switch(c.actionName){case"delete":if(c.objectIDs){for(var a in c.objectIDs){this.removeImage(c.objectIDs[a])}}this.setUserImageCount(c.returnValues.userImageCount);new WCF.System.Notification().show();break;case"saveImageData":this._handleSavedImageData(c.returnValues);break}},addDataHandler:function(a,b){this._dataHandlers[a]=b;b.setImageHandler(this)},addImage:function(b,d){if(!this._thumbnailListContainer.is(":visible")&&this._tmpHash){this._thumbnailListContainer.show()}if(this._tmpHash){for(var c in this._initialData){d.set(c,this._initialData[c])}}this._images[b]=d;d.setImageHandler(this);for(var a in this._callbacks.addImage){this._callbacks.addImage[a](d)}},addInitialData:function(a,b){this._initialData[a]=b},getActiveImage:function(){if(this._images[this._activeImageID]!==undefined){return this._images[this._activeImageID]}return null},getDataHandler:function(a){if(this._dataHandlers[a]!==undefined){return this._dataHandlers[a]}return null},getDataHandlers:function(){return this._dataHandlers},getImage:function(a){if(this._images[a]!==undefined){return this._images[a]}return null},getImages:function(){return this._images},getTmpHash:function(){return this._tmpHash},registerCallback:function(a,b){if(a!="addImage"&&a!="removeImage"){console.debug("[Gallery.Image.Handler] Unknown callback event '"+a+"'");return false}if(!$.isFunction(b)){console.debug("[Gallery.Image.Handler] Callback for '"+a+"' is invalid");return false}this._callbacks[a].push(b)},removeDataHandler:function(a){if(this._dataHandlers[a]!==undefined){delete this._dataHandlers[a];return true}return false},removeImage:function(b){if(this._images[b]!==undefined){this._images[b].remove();delete this._images[b];for(var a in this._callbacks.removeImage){this._callbacks.removeImage[a](b)}if(!$.getLength(this._images)){this._imageContainer.hide();this._activeImageID=0}else{if(b==this._activeImageID){this._activeImageID=0;$("#thumbnailList > li:eq(0)").each($.proxy(function(c,d){this.setActiveImage(this._images[$(d).data("imageID")])},this))}}return true}return false},removeImageByClick:function(a){WCF.System.Confirmation.show(WCF.Language.get("gallery.image.delete.confirmMessage"),$.proxy(function(b){if(b==="confirm"){this._proxy.setOption("data",{actionName:"delete",className:"gallery\\data\\image\\ImageAction",objectIDs:[$(a.currentTarget).data("imageID")],parameters:{returnUserImageCount:1}});this._proxy.sendRequest()}},this))},setActiveImage:function(b){if(this._activeImageID){var a=this._images[this._activeImageID].getData();for(var c in this._dataHandlers){this._dataHandlers[c].readData();a=$.extend(a,this._dataHandlers[c].getData())}this._images[this._activeImageID].setData(a)}this._activeImageID=b.getImageID();$("#thumbnailList").children("li").removeClass("active");if(b.getThumbnail()){b.getThumbnail().parent("li").addClass("active")}if(!this._image){this._image=$('<img src="" alt="" />').click($.proxy(this._thumbnailAreaSelector._click,this._thumbnailAreaSelector)).appendTo($("#image"))}this._image.attr("src",b.get("url")).on("load",$.proxy(this._thumbnailAreaSelector.refresh,this._thumbnailAreaSelector));for(var c in this._dataHandlers){this._dataHandlers[c].updateData()}},setEditedImageData:function(a){this.addImage(a.imageID,new Gallery.Image.Handler.Image(a.imageID,a));this._imageContainer.show();this.setActiveImage(this.getImage(a.imageID))},setFirstImageActive:function(){var a=this.getImage($("#thumbnailList").children("li:eq(0)").data("imageID"));if(a){if(!this._imageContainer.is(":visible")){this._imageContainer.show()}this.setActiveImage(a)}},setRedirectURL:function(a){this._redirectURL=a},setUserImageCount:function(a){if(this._uploadHandler){if(this._userImageCount>=this._maxUserImageCount&&a<this._maxUserImageCount){this._thumbnailListContainer.show();this._uploadHandler.showUploadButton();if(this._uploadWarning){this._uploadWarning.hide()}}else{if(a>this._userImageCount&&a>=this._maxUserImageCount){this._uploadHandler.hideUploadButton();if(!this._uploadWarning){this._uploadWarning=$('<p class="warning" />').text(WCF.Language.get("gallery.image.upload.error.tooManyImages")).insertBefore(this._thumbnailListContainer)}else{this._uploadWarning.show()}}}}this._userImageCount=a},validate:function(){var b=true;for(var a in this._images){if(!this._images[a].validate()){b=false}}return b}});Gallery.Image.ImagesInMotion=Class.extend({_container:null,_effectOptions:{},init:function(b,a,c){if(a.length<2){console.debug("[Gallery.Image.ImagesInMotion] At least two images are required but "+a.length+" are given, aborting.");return}this._container=$("#"+b);if(!this._container.length){console.debug("[Gallery.Image.ImagesInMotion] Container id '"+b+"' is invalid, aborting.");return}this._effectOptions=c||{};shuffle(a);var d=null;var e=false;for(var g=0,f=a.length;g<f;g++){d=$('<img src="'+a[g].url+'" />').data("imageData",a[g]).appendTo(this._container);if(g===0){if(d.get(0).complete){e=true}else{d.load($.proxy(this._initKenBurnsEffect,this))}}}if(e){this._initKenBurnsEffect()}},_initKenBurnsEffect:function(){this._container.removeClass("loading").kenburns(this._effectOptions)}});$.widget("gallery.kenburns",{_activeCanvas:1,_animationIDs:[],_canvases:[],_caption:null,_current:{height:0,width:0,x:0,y:0},_images:[],_imageData:[],_index:-1,_link:null,_resumeAnimationCallbacks:[],_supportedAlignments:[],_updateCanvasDimensionsCallbacks:[],_userAvatar:null,options:{duration:7000,randomizeZoom:true,zoomFactor:0.9},_create:function(){this._activeCanvas=1;this._animationIDs=[0,0];this._images=[];this._imageData=[];this._index=-1;this._resumeAnimationCallbacks=[null,null];this._updateCanvasDimensionsCallbacks=[null,null];this._supportedAlignments=["top","left","bottom","center","right"];this._canvases=[$('<canvas class="kenburns" />').appendTo(this.element).get(0),$('<canvas class="kenburns" />').appendTo(this.element).get(0)];this._link=$('<a class="box48 framed"></a>').appendTo(this.element);this._userAvatar=$("<img />").appendTo(this._link);this._caption=$("<h1 />").appendTo(this._link);this.updateCanvasDimensions();this.options.zoomFactor=Math.abs(this.options.zoomFactor);this.options.zoomFactor=Math.min(Math.max(this.options.zoomFactor,0.5),1.5);this.element.children("img").each($.proxy(function(a,b){this._images.push(b);this._imageData.push($(b).data("imageData"))},this));WCF.PageVisibilityHandler.addCallback("gallery.kenburns."+this.element.wcfIdentify().hashCode(),$.proxy(function(a){if(a){this.pause()}else{this.resume()}},this));$(window).resize($.proxy(this.updateCanvasDimensions,this));this.start()},updateCanvasDimensions:function(){var a=this.element.getDimensions("inner");this._canvases[0].height=a.height;this._canvases[0].width=a.width;this._canvases[1].height=a.height;this._canvases[1].width=a.width;if(this._updateCanvasDimensionsCallbacks[0]){this._updateCanvasDimensionsCallbacks[0]()}if(this._updateCanvasDimensionsCallbacks[1]){this._updateCanvasDimensionsCallbacks[1]()}},start:function(){var b=(this._index===-1);this._index++;if(this._index===this._images.length){this._index=0}$(this._canvases[this._activeCanvas]).removeClass("primary").addClass("secondary");this._activeCanvas=(this._activeCanvas?0:1);var c=this._canvases[this._activeCanvas];$(c).addClass("primary").removeClass("secondary");var a=this._images[this._index];this._current=this.getCurrentImageDimensions(a,c);var d=this._imageData[this._index];this._caption.html(d.title);this._link.prop("href",d.link);this._userAvatar.prop("src",d.avatar);this._render(c,b)},getCurrentImageDimensions:function(d,b){var c={height:Math.floor((b.width/d.width)*d.height),width:b.width,x:0,y:0};if(c.height<b.height){var a=b.height/c.height;c.height=b.height;c.width=b.width*a}if(b.width<700){c.height*=2;c.width*=2}c.x=(c.width-b.width)/2*-1;c.y=(c.height-b.height)/2*-1;return c},pause:function(){if(this._animationIDs[0]){cancelAnimationFrame(this._animationIDs[0])}if(this._animationIDs[1]){cancelAnimationFrame(this._animationIDs[1])}},resume:function(){if(this._resumeAnimationCallbacks[0]!==null){this._resumeAnimationCallbacks[0]()}if(this._resumeAnimationCallbacks[1]!==null){this._resumeAnimationCallbacks[1]()}},_getAlignment:function(f,c,b,d,a,e,i){var h=0;var g=0;switch(i){case"top":h=(a-b)/2*-1;break;case"left":g=(e-d)/2*-1;break;case"bottom":h=(a-b)/2*-1;g=(e-d)*-1;break;case"right":h=(a-b)*-1;g=(e-d)/2*-1;break;default:h=(a-b)/2*-1;g=(e-d)/2*-1;break}return{x:f+h,y:c+g}},_scaleImage:function(c,e,f){var d=Math.floor(c.width*e);var b=Math.floor(c.height*e);var a=this._getAlignment(c.x,c.y,c.width,c.height,d,b,f);return{height:b,width:d,x:a.x,y:a.y}},_render:function(d,r){var f=this._supportedAlignments[Math.floor(Math.random()*this._supportedAlignments.length)];var c=this._activeCanvas;var o=d.getContext("2d");var b=this._current;var u=this._index;var s=this.options.zoomFactor;if(this.options.randomizeZoom&&(Math.round(Math.random()))){s=2-s}if(d.width<700){if(s<1){s=1-s;s=1-(s*2)}else{s=1-s;s=1+s*2}}var j=1;var i=0;var h=1;var n=s;if(n>1){i=Math.abs(s-1)/this.options.duration}else{j=(1-s)+1;h=j;i=(1-s)/this.options.duration;n=1}var t=null;var m=0;var p=0;var l=(r?1000:0);var e=this.options.duration-1000;var v=false;var q=false;var a=false;var k=this;this._resumeAnimationCallbacks[c]=function(){q=true;k._animationIDs[c]=requestAnimationFrame(g)};this._updateCanvasDimensionsCallbacks[c]=function(){b=k.getCurrentImageDimensions(k._images[u],d)};function g(y){if(t===null){t=y}if(q){q=false;t=y-m}m=y-t;var w=k._scaleImage(b,j,f);var x=k._images[u];if(m<l){p=m/l}else{if(m>e){p=(k.options.duration-m)/1000;if(!v){v=true;k.start()}}else{p=1}}o.clearRect(0,0,d.width,d.height);o.globalAlpha=p;o.drawImage(x,0,0,x.width,x.height,w.x,w.y,w.width,w.height);a=false;if(s>1){j=1+i*m;if(j<n){a=true}}else{j=h-i*m;if(j>n){a=true}}if(a){k._animationIDs[c]=requestAnimationFrame(g)}else{k._resumeAnimationCallbacks[c]=null;k._updateCanvasDimensionsCallbacks[c]=null}}this._animationIDs[c]=requestAnimationFrame(g)}});Gallery.Image.Share=WCF.Message.Share.Content.extend({_smallImageURL:"",_largeImageURL:"",init:function(a,b){this._smallImageURL=a;this._largeImageURL=b;this._super()},_click:function(d){d.preventDefault();var a=$(d.currentTarget);var b=a.prop("href");var c=b.hashCode();if(this._cache[c]===undefined){var f=false;if(this._dialog===null){this._dialog=$("<div />").hide().appendTo(document.body);f=true}else{this._dialog.empty()}var e=$('<fieldset><legend><label for="__sharePermalink">'+WCF.Language.get("wcf.message.share.permalink")+"</label></legend></fieldset>").appendTo(this._dialog);$('<input type="text" id="__sharePermalink" class="long" readonly="readonly" />').attr("value",b).appendTo(e);if(this._smallImageURL){var e=$('<fieldset><legend><label for="__shareSmallImageBBCode">'+WCF.Language.get("wcf.message.share.permalink.bbcode")+" ("+WCF.Language.get("gallery.image.share.smallImage")+")</label></legend></fieldset>").appendTo(this._dialog);$('<input type="text" id="__shareSmallImageBBCode" class="long" readonly="readonly" />').attr("value","[url='"+b+"'][img]"+this._smallImageURL+"[/img][/url]").appendTo(e);var e=$('<fieldset><legend><label for="__shareLargeImageBBCode">'+WCF.Language.get("wcf.message.share.permalink.bbcode")+" ("+WCF.Language.get("gallery.image.share.largeImage")+")</label></legend></fieldset>").appendTo(this._dialog);$('<input type="text" id="__shareLargeImageBBCode" class="long" readonly="readonly" />').attr("value","[url='"+b+"'][img]"+this._largeImageURL+"[/img][/url]").appendTo(e);var e=$('<fieldset><legend><label for="__shareSmallImageHTML">'+WCF.Language.get("wcf.message.share.permalink.html")+" ("+WCF.Language.get("gallery.image.share.smallImage")+")</label></legend></fieldset>").appendTo(this._dialog);$('<input type="text" id="__shareSmallImageHTML" class="long" readonly="readonly" />').attr("value",'<a href="'+b+'"><img src="'+this._smallImageURL+'" alt="" /></a>').appendTo(e);var e=$('<fieldset><legend><label for="__shareLargeImageHTML">'+WCF.Language.get("wcf.message.share.permalink.html")+" ("+WCF.Language.get("gallery.image.share.largeImage")+")</label></legend></fieldset>").appendTo(this._dialog);$('<input type="text" id="__shareLargeImageHTML" class="long" readonly="readonly" />').attr("value",'<a href="'+b+'"><img src="'+this._largeImageURL+'" alt="" /></a>').appendTo(e)}else{var e=$('<fieldset><legend><label for="__shareImageBBCode">'+WCF.Language.get("wcf.message.share.permalink.bbcode")+"</label></legend></fieldset>").appendTo(this._dialog);$('<input type="text" id="__shareImageBBCode" class="long" readonly="readonly" />').attr("value","[url='"+b+"'][img]"+this._largeImageURL+"[/img][/url]").appendTo(e);var e=$('<fieldset><legend><label for="__shareImageHTML">'+WCF.Language.get("wcf.message.share.permalink.html")+"</label></legend></fieldset>").appendTo(this._dialog);$('<input type="text" id="__shareImageHTML" class="long" readonly="readonly" />').attr("value",'<a href="'+b+'"><img src="'+this._largeImageURL+'" alt="" /></a>').appendTo(e)}this._cache[c]=this._dialog.html();if(f){this._dialog.wcfDialog({title:WCF.Language.get("wcf.message.share")})}else{this._dialog.wcfDialog("open")}}else{this._dialog.html(this._cache[c]).wcfDialog("open")}this._enableSelection()}});Gallery.Image.Slideshow={_didInit:false,init:function(){if(this._didInit){return}this._didInit=true;this._domNodeInserted();WCF.DOMNodeInsertedHandler.addCallback("Gallery.Image.Slideshow",$.proxy(this._domNodeInserted,this))},_domNodeInserted:function(){if($.browser.touch&&/[Mm]obile/.test(navigator.userAgent)&&!(/iPad/.test(navigator.userAgent))){$(".jsGalleryAlbumImageViewer.button").hide();$(".jsGalleryAlbumImageViewer").removeClass("jsGalleryAlbumImageViewer");$(".jsGalleryCategoryImageViewer.button").hide();$(".jsGalleryCategoryImageViewer").removeClass("jsGalleryCategoryImageViewer");$(".jsGalleryUserImageViewer.button").hide();$(".jsGalleryUserImageViewer").removeClass("jsGalleryUserImageViewer")}else{$(".jsGalleryAlbumImageViewer").removeClass("jsGalleryAlbumImageViewer").wcfImageViewer({className:"gallery\\data\\album\\AlbumAction"});$(".jsGalleryCategoryImageViewer").removeClass("jsGalleryCategoryImageViewer").wcfImageViewer({className:"gallery\\data\\category\\GalleryCategoryAction"});$(".jsGalleryUserImageViewer").removeClass("jsGalleryUserImageViewer").wcfImageViewer({className:"gallery\\data\\image\\ImageAction"})}}};Gallery.Image.Upload=WCF.Upload.Parallel.extend({_archiveUploadSuccess:null,_imageHandler:null,_listItems:{},_maxParallelUploads:0,_quotaExceededError:null,_thumbnailGenerator:null,_tooManyImagesError:null,_visibleArchiveUploadSuccess:false,init:function(b,a){this._imageHandler=b;this._maxParallelUploads=a;this._super($("#thumbnailList"),$("#thumbnailList"),"gallery\\data\\image\\ImageAction")},_createButton:function(){if(this._supportsAJAXUpload){this._fileUpload=$('<input type="file" name="'+this._name+'" '+(this._options.multiple?'multiple="true" ':"")+"/>");this._fileUpload.change($.proxy(this._upload,this));var a=$('<li class="jsImageUpload jsTooltip" title="'+WCF.Language.get("gallery.image.button.upload")+'"><span class="icon icon32 icon-upload"></span></li>');a.prepend(this._fileUpload)}else{var a=$('<li class="jsImageUpload jsImageUploadFallback jsTooltip" title="'+WCF.Language.get("gallery.image.button.upload")+'"><span class="icon icon32 icon-upload"></span> <span>'+WCF.Language.get("wcf.global.button.upload")+"</span></li>");a.click($.proxy(this._showOverlay,this))}this._insertButton(a);WCF.DOMNodeInsertedHandler.execute()},_error:function(a,c,b){console.log(a,c,b)},_getParameters:function(){return{tmpHash:this._imageHandler.getTmpHash()}},_getThumbnailGenerator:function(){if(this._thumbnailGenerator===null){this._thumbnailGenerator=new Gallery.Image.ThumbnailGenerator()}return this._thumbnailGenerator},_initFile:function(b){var a=$('<li><progress max="100" /><span class="icon icon32 icon-spinner"></span></li>').insertBefore(this._fileListSelector.find(".jsImageUpload"));if(this._fileListSelector.children("li").length==2){a.on("didLoadImage",$.proxy(this._imageHandler.setFirstImageActive,this._imageHandler))}return a},_removeButton:function(){this._buttonSelector.find(".jsImageUpload").remove()},_success:function(b,d){if(!d.returnValues){return}var h=this._uploadMatrix[b];h.find("progress").remove();if(d.returnValues.images&&d.returnValues.images[b]){var i=d.returnValues.images[b];$thumbnail=$('<img src="'+i.tinyURL+'" alt="" />');h.data("imageID",i.imageID).children(".icon-spinner").replaceWith($thumbnail);var j=$('<ul class="imageOptions" />').appendTo(h);j.append($("<li />").append($('<span class="icon icon16 icon-remove pointer jsTooltip" title="'+WCF.Language.get("wcf.global.button.delete")+'" />').data("imageID",i.imageID).click($.proxy(this._imageHandler.removeImageByClick,this._imageHandler))));h.append(j);this._imageHandler.addImage(i.imageID,new Gallery.Image.Handler.Image(i.imageID,i,$thumbnail));h.trigger("didLoadImage");h.css("display","block")}else{if(d.returnValues.archiveImages&&d.returnValues.archiveImages[b]){h.remove();if(!this._archiveUploadSuccess){this._archiveUploadSuccess=new WCF.System.Notification(WCF.Language.get("gallery.image.upload.archive.success"))}if(!this._visibleArchiveUploadSuccess){this._visibleArchiveUploadSuccess=true;this._archiveUploadSuccess.show($.proxy(this._setArchiveUploadSuccessHidden))}for(var c in d.returnValues.archiveImages[b]){var i=d.returnValues.archiveImages[b][c];var h=$("<li />").data("imageID",c).data("imageData",i).on("didLoadImage",$.proxy(this._imageHandler.setFirstImageActive,this._imageHandler)).append($('<span class="icon icon32 icon-spinner" />'));this._fileListSelector.find(".jsImageUpload").before(h);this._listItems[c]=h;if(d.returnValues.pendingThumbnails){this._getThumbnailGenerator().generateThumbnails(i.imageID,$.proxy(function(k,m){if(m[k]&&m[k].tinyURL){var n=this._listItems[k];var l=$('<img src="'+m[k].tinyURL+'" alt="" />').load($.proxy(function(p){n.children(".icon-spinner").replaceWith($(p.currentTarget));var o=$('<ul class="imageOptions" />').appendTo(n);o.append($("<li />").append($('<span class="icon icon16 icon-remove pointer jsTooltip" title="'+WCF.Language.get("wcf.global.button.delete")+'" />').data("imageID",k).click($.proxy(this._imageHandler.removeImageByClick,this._imageHandler))));n.append(o);n.trigger("didLoadImage")},this));this._imageHandler.addImage(k,new Gallery.Image.Handler.Image(k,n.data("imageData"),l))}},this))}else{$thumbnail=$('<img src="'+i.tinyURL+'" alt="" />');h.data("imageID",i.imageID).children(".icon-spinner").replaceWith($thumbnail);var j=$('<ul class="imageOptions" />').appendTo(h);j.append($("<li />").append($('<span class="icon icon16 icon-remove pointer jsTooltip" title="'+WCF.Language.get("wcf.global.button.delete")+'" />').data("imageID",i.imageID).click($.proxy(this._imageHandler.removeImageByClick,this._imageHandler))));h.append(j);this._imageHandler.addImage(i.imageID,new Gallery.Image.Handler.Image(i.imageID,i,$thumbnail));h.trigger("didLoadImage")}}if(d.returnValues.archiveErrors[b]&&d.returnValues.archiveErrors[b].files&&d.returnValues.archiveErrors[b].files.length){var a=$('<div class="info pointer" />').text(d.returnValues.archiveErrors[b].errorMessage).insertBefore($("#thumbnailListContainer")).click(function(){this.remove()});var e=$('<ul class="nativeList" />').appendTo(a);for(var f in d.returnValues.archiveErrors[b].files){e.append($("<li />").text(d.returnValues.archiveErrors[b].files[f].errorMessage))}}}}if(d.returnValues.errors&&d.returnValues.errors[b]){if(d.returnValues.archiveImages&&!d.returnValues.archiveImages[b]){h.remove()}switch(d.returnValues.errors[b].errorType){case"quotaExceeded":if(!this._quotaExceededError){this._quotaExceededError=$('<p class="error pointer" />').text(d.returnValues.errors[b].errorMessage).insertBefore($("#thumbnailListContainer")).click(function(){$(this).hide()})}this._quotaExceededError.show();break;case"tooManyImages":if(!this._tooManyImagesError){this._tooManyImagesError=$('<p class="error pointer" />').text(d.returnValues.errors[b].errorMessage).insertBefore($("#thumbnailListContainer")).click(function(){$(this).hide()})}this._tooManyImagesError.show();break;default:var g=$('<p class="error pointer" />').text(d.returnValues.errors[b].errorMessage).insertBefore($("#thumbnailListContainer")).click(function(){this.remove()});break}}this._imageHandler.setUserImageCount(d.returnValues.userImageCount);WCF.DOMNodeInsertedHandler.execute()},_upload:function(){var a=this._fileUpload.prop("files");if(a.length>this._maxParallelUploads){$('<p class="error pointer" />').text(WCF.Language.get("gallery.image.upload.error.maxParallelFileUpload")).insertBefore($("#thumbnailListContainer")).click(function(){this.remove()})}else{this._super()}},_setArchiveUploadSuccessHidden:function(){this._visibleArchiveUploadSuccess=false},hideUploadButton:function(){this._buttonSelector.find(".jsImageUpload").hide()},showUploadButton:function(){this._buttonSelector.find(".jsImageUpload").show()}});Gallery.Image.ThumbnailGenerator=Class.extend({generateThumbnails:function(a,c,b){b=b||false;new WCF.Action.Proxy({autoSend:true,data:{actionName:"generateThumbnails",className:"gallery\\data\\image\\ImageAction",objectIDs:[a],parameters:{refresh:b}},showLoadingOverlay:false,success:$.proxy(function(e,f,d){if(e.returnValues.pendingThumbnails){this.generateThumbnails(a,c)}else{if($.isFunction(c)){c(a,e.returnValues)}}},this)})}});Gallery.Image.Handler.Image=Class.extend({_createThumbnail:false,_data:{},_errors:{},_imageID:0,_imageHandler:null,_removeImageIcon:null,_thumbnail:null,init:function(c,d,f,b){this._imageID=c;this._data=d||{};this._thumbnail=f||null;this._createThumbnail=b||false;if(this._thumbnail){this._thumbnail.click($.proxy(this._editImage,this))}else{if(this._createThumbnail){var e=$("<li />").data("imageID",c).data("imageData",d);$("#thumbnailList").find(".jsImageUpload").before(e);this._thumbnail=$('<img src="'+d.tinyURL+'" alt="" />');e.append(this._thumbnail);var a=$('<ul class="imageOptions" />').appendTo(e);this._removeImageIcon=$('<span class="icon icon16 icon-remove pointer jsTooltip" title="'+WCF.Language.get("wcf.global.button.delete")+'" />').data("imageID",c);a.append($("<li />").append(this._removeImageIcon));e.append(a);e.trigger("didLoadImage");this._thumbnail.click($.proxy(this._editImage,this))}}},_editImage:function(){this._imageHandler.setActiveImage(this)},addError:function(a,b){this._errors[a]=b},get:function(a){if(this._data[a]!==undefined){return this._data[a]}return null},getData:function(){return this._data},getErrors:function(){return this._errors},getImageID:function(){return this._imageID},getImageHandler:function(){return this._imageHandler},getThumbnail:function(){return this._thumbnail},remove:function(){this._thumbnail.parent("li").remove()},set:function(a,b){this._data[a]=b},setData:function(a){this._data=a},setErrors:function(a){this._errors=a},setImageHandler:function(a){this._imageHandler=a;if(this._removeImageIcon){this._removeImageIcon.click($.proxy(this._imageHandler.removeImageByClick,this._imageHandler))}},validate:function(){this.setErrors({});var a=this._imageHandler.getDataHandlers();for(var b in a){if(!a[b].validateData(this)){if(this._thumbnail){this._thumbnail.parent("li").addClass("imageError")}return false}}if(this._thumbnail&&this._thumbnail.parent("li").hasClass("imageError")){this._thumbnail.parent("li").removeClass("imageError")}return true}});Gallery.Image.Clipboard=Class.extend({_categoryID:0,_environment:"category",_updateHandler:null,init:function(updateHandler,environment,categoryID){this._updateHandler=updateHandler;this._environment=environment;this._categoryID=(categoryID)?categoryID:0;this._dialog=$("<div />").appendTo(document.body);this._proxy=new WCF.Action.Proxy({success:$.proxy(this._success,this)});$(".jsClipboardEditor").each($.proxy(function(index,container){var $container=$(container);var $types=eval($container.data("types"));if(WCF.inArray("com.woltlab.gallery.image",$types)){$container.on("clipboardAction",$.proxy(this._execute,this));$container.on("clipboardActionResponse",$.proxy(this._evaluateResponse,this));return false}},this))},_execute:function(d,b,a,c){if(b!=="com.woltlab.gallery.image"){return}switch(a){case"com.woltlab.gallery.image.moveToAlbum":this._proxy.setOption("data",{actionName:"prepareMoveToAlbum",className:"gallery\\data\\image\\ImageAction",objectIDs:c.objectIDs});this._proxy.sendRequest();break}},_evaluateResponse:function(e,f,c,a,d){if(c!=="com.woltlab.gallery.image"){return}if(!f.returnValues.imageData||!$.getLength(f.returnValues.imageData)){return}for(var b in f.returnValues.imageData){this._updateHandler.update(b,f.returnValues.imageData[b])}},_moveToAlbum:function(a){this._proxy.setOption("data",{actionName:"moveToAlbum",className:"gallery\\data\\image\\ImageAction",objectIDs:this._dialog.data("objectIDs"),parameters:{albumID:parseInt(this._dialog.find("#albumID").val())}});this._proxy.sendRequest();this._dialog.wcfDialog("close")},_success:function(b,c,a){switch(b.actionName){case"prepareMoveToAlbum":this._dialog.data("objectIDs",b.objectIDs).html(b.returnValues.template);this._dialog.wcfDialog({title:WCF.Language.get("gallery.image.moveToAlbum")});this._dialog.find(".formSubmit > input[type=submit]").click($.proxy(this._moveToAlbum,this));break;case"moveToAlbum":window.location.reload();break}}});Gallery.Image.UpdateHandler=Class.extend({_images:{},init:function(){$(".galleryImage").each($.proxy(function(a,c){var b=$(c);this._images[b.data("objectID")]=b},this))},update:function(a,c){if(!this._images[a]){console.debug("[Gallery.Image.UpdateHandler] Unknown image id "+a);return}for(var b in c){this._updateProperty(a,b,c[b])}},_updateProperty:function(a,c,b){switch(c){case"deleted":this._delete(a,b);break;case"deleteNote":this._deleteNote(a,b);break;case"isDeleted":if(b){this._trash(a)}else{this._restore(a)}break;case"isDisabled":if(b){this._disable(a)}else{this._enable(a)}break;default:this._handleCustomProperty(a,c,b);break}},_handleCustomProperty:function(a,c,b){this._images[a].trigger("imageUpdateHandlerProperty",[a,c,b])},_delete:function(a,b){},_deleteNote:function(a,b){},_disable:function(a){this._images[a].data("isDisabled",1)},_enable:function(a){this._images[a].data("isDisabled",0)},_restore:function(a){this._images[a].data("isDeleted",0)},_trash:function(a){this._images[a].data("isDeleted",1)},getValue:function(a,b){if(!this._images[a]){console.debug("[Gallery.Image.UpdateHandler] Unknown image id "+a);return}switch(b){case"isDeleted":return this._images[a].data("isDeleted");break;case"isDisabled":return this._images[a].data("isDisabled");break}}});Gallery.Image.UpdateHandler.ImageList=Gallery.Image.UpdateHandler.extend({_delete:function(a,b){this._images[a].remove();delete this._images[a];WCF.Clipboard.reload()},_disable:function(a){this._super(a);this._images[a].addClass("imageDisabled")},_enable:function(a){this._super(a);this._images[a].removeClass("imageDisabled")},_restore:function(a){this._super(a);this._images[a].removeClass("imageDeleted")},_trash:function(a){this._super(a);this._images[a].addClass("imageDeleted")}});Gallery.Image.UpdateHandler.Image=Gallery.Image.UpdateHandler.extend({_delete:function(a,b){new WCF.PeriodicalExecuter(function(c){c.stop();window.location=b},1000)},_deleteNote:function(a,b){$('<p class="messageFooterNote marginTopSmall galleryImageDeleteNote">'+b+"</p>").prependTo($(".galleryImageContainer"))},_disable:function(c){this._super(c);var a=$('<span class="badge label jsLabelDisabled">'+WCF.Language.get("gallery.image.isDisabled")+"</span>");var b=$(".galleryImageHeadline > h1");var d=b.children(".jsLabelDeleted");if(d.length){a.insertAfter(d)}else{a.prependTo(b)}a.append(" ")},_enable:function(a){this._super(a);$(".galleryImageHeadline > h1 > .jsLabelDisabled").remove()},_restore:function(a){this._super(a);$(".galleryImageHeadline > h1 > .jsLabelDeleted").remove();this._images[a].parent().find(".galleryImageDeleteNote").remove()},_trash:function(b){this._super(b);var a=$('<span class="badge label red jsLabelDeleted">'+WCF.Language.get("gallery.image.isDeleted")+"</span>").prependTo($(".galleryImageHeadline > h1"));a.append(" ")}});Gallery.Image.DataHandler={};Gallery.Image.DataHandler.Base=Class.extend({_data:{},_imageHandler:null,_overwriteIcons:[],init:function(){this._data={};this._imageHandler=null;this._overwriteIcons=[]},_toggleOverwriteIcons:function(){if($.getLength(this._imageHandler.getImages())==1){for(var a in this._overwriteIcons){this._overwriteIcons[a].hide()}}else{for(var a in this._overwriteIcons){this._overwriteIcons[a].show()}}},getData:function(){return this._data},getImageHandler:function(){return this._imageHandler},readData:function(){},setImageHandler:function(a){this._imageHandler=a;this._imageHandler.registerCallback("addImage",$.proxy(this._toggleOverwriteIcons,this));this._imageHandler.registerCallback("removeImage",$.proxy(this._toggleOverwriteIcons,this))},updateData:function(){},validateData:function(a){return true}});Gallery.Image.DataHandler.Default=Gallery.Image.DataHandler.Base.extend({_categoryIDs:[],_categoryIDsError:null,_descriptionError:null,_titleError:null,init:function(d){this._super();this._categoryIDs=d;var b=$('<span class="icon icon16 icon-refresh pointer jsTooltip galleryOverwriteIcon" title="'+WCF.Language.get("gallery.image.button.overwrite")+'" />').click($.proxy(this._overwriteTitle,this));this._overwriteIcons.push(b);var c=$("#title").parent().prev("dt");c.children("label").css("display","inline-block");c.append(b);var a=$('<span class="icon icon16 icon-refresh pointer jsTooltip galleryOverwriteIcon" title="'+WCF.Language.get("gallery.image.button.overwrite")+'" />').click($.proxy(this._overwriteCategories,this));this._overwriteIcons.push(a);$("#categoryList").prev("legend").append(a);var e=$('<span class="icon icon16 icon-refresh pointer jsTooltip galleryOverwriteIcon" title="'+WCF.Language.get("gallery.image.button.overwrite")+'" />').click($.proxy(this._overwriteDescription,this));this._overwriteIcons.push(e);var c=$("#text").parent().prev("dt");c.children("label").css("display","inline-block");c.append(e)},_getCategoryIDs:function(){var a=[];$('input[name="categoryIDs[]"]').each(function(c,d){var b=$(d);if(b.prop("checked")){a.push(parseInt(b.val()))}});return a},_hideCategoryIDsError:function(){if(this._categoryIDsError!==null){this._categoryIDsError.hide()}},_hideDescriptionError:function(){if(this._descriptionError!==null){this._descriptionError.hide()}},_hideTitleError:function(){if(this._titleError!==null){this._titleError.hide()}},_needCategoriesOverwriteConfirmation:function(){var b=this.getImageHandler().getImages();for(var a in b){if(this.getImageHandler().getActiveImage().getImageID()==a){continue}var c=b[a].get("categoryIDs");if(c&&c.length){return true}}return false},_needDescriptionOverwriteConfirmation:function(){var b=this.getImageHandler().getImages();for(var a in b){if(this.getImageHandler().getActiveImage().getImageID()==a){continue}if($.trim(b[a].get("description"))){return true}}return false},_needTitleOverwriteConfirmation:function(){var b=this.getImageHandler().getImages();for(var a in b){if(this.getImageHandler().getActiveImage().getImageID()==a){continue}if(b[a].get("title")){return true}}return false},_overwriteCategories:function(a){a.preventDefault();if(this._needCategoriesOverwriteConfirmation()){WCF.System.Confirmation.show(WCF.Language.get("gallery.image.categoryIDs.overwrite.confirmMessage"),$.proxy(function(b){if(b==="confirm"){this._setCategoryIDs()}},this))}else{this._setCategoryIDs()}},_overwriteDescription:function(a){a.preventDefault();if(this._needDescriptionOverwriteConfirmation()){WCF.System.Confirmation.show(WCF.Language.get("gallery.image.description.overwrite.confirmMessage"),$.proxy(function(b){if(b==="confirm"){this._setDescription()}},this))}else{this._setDescription()}},_overwriteTitle:function(a){a.preventDefault();if(this._needTitleOverwriteConfirmation()){WCF.System.Confirmation.show(WCF.Language.get("gallery.image.title.overwrite.confirmMessage"),$.proxy(function(b){if(b==="confirm"){this._setTitle()}},this))}else{this._setTitle()}},_setCategoryIDs:function(){var c=this._getCategoryIDs();var b=this.getImageHandler().getImages();for(var a in b){if(this.getImageHandler().getActiveImage().getImageID()==a){continue}b[a].set("categoryIDs",c)}new WCF.System.Notification().show()},_setDescription:function(){var a=$("#text").val();var c=this.getImageHandler().getImages();for(var b in c){if(this.getImageHandler().getActiveImage().getImageID()==b){continue}c[b].set("description",a)}new WCF.System.Notification().show()},_setTitle:function(){var c=$("#title").val();var b=this.getImageHandler().getImages();for(var a in b){if(this.getImageHandler().getActiveImage().getImageID()==a){continue}b[a].set("title",c)}new WCF.System.Notification().show()},_showCategoryIDsError:function(a){if(this._categoryIDsError===null){this._categoryIDsError=$('<small class="innerError" />').hide();$("#categoryList").after(this._categoryIDsError)}this._categoryIDsError.text(a).show()},_showDescriptionError:function(a){if(this._descriptionError===null){this._descriptionError=$('<small class="innerError" />').hide();$("#text").after(this._descriptionError)}this._descriptionError.text(a).show()},_showTitleError:function(a){if(this._titleError===null){this._titleError=$('<small class="innerError" />').hide();$("#title").after(this._titleError)}this._titleError.text(a).show()},readData:function(){this._data={categoryIDs:this._getCategoryIDs(),description:$("#text").val(),title:$("#title").val(),enableComments:($("#enableComments").prop("checked")?1:0)}},updateData:function(){var a=this.getImageHandler().getActiveImage().getData();this._data={categoryIDs:a.categoryIDs||[],description:a.description||"",title:a.title||"",enableComments:a.enableComments!==undefined?a.enableComments:1};var b=this.getImageHandler().getActiveImage().getErrors();if(b.categoryIDs!==undefined){this._showCategoryIDsError(b.categoryIDs)}else{this._hideCategoryIDsError()}if(b.description!==undefined){this._showDescriptionError(b.description)}else{this._hideDescriptionError()}if(b.title!==undefined){this._showTitleError(b.title)}else{this._hideTitleError()}$("#title").val(this._data.title);$("#text").val(this._data.description);$('input[name="categoryIDs[]"]').each($.proxy(function(d,e){var c=$(e);if(this._data.categoryIDs.indexOf(parseInt(c.val()))==-1){c.prop("checked",false)}else{c.prop("checked",true)}},this));if(this._data.enableComments){$("#enableComments").prop("checked",true)}else{$("#enableComments").prop("checked",false)}},validateData:function(d){var b=d.getData();var c=true;if(b.title===undefined||b.title==""){d.addError("title",WCF.Language.get("wcf.global.form.error.empty"));c=false}else{if(b.title.length>255){d.addError("title",WCF.Language.get("gallery.image.title.error.tooLong"));c=false}}if(b.description===undefined){b.description=""}else{if(b.description.length>this.getImageHandler()._maxDescriptionLength){d.addError("description",WCF.Language.get("gallery.image.description.error.tooLong"));c=false}}if(b.categoryIDs===undefined||!b.categoryIDs.length){d.addError("categoryIDs",WCF.Language.get("wcf.global.form.error.empty"));c=false}else{for(var a in b.categoryIDs){if(this._categoryIDs.indexOf(b.categoryIDs[a])==-1){d.addError("categoryIDs",WCF.Language.get("gallery.image.categoryIDs.error.notValid"));c=false;break}}}return c}});Gallery.Image.DataHandler.Album=Gallery.Image.DataHandler.Base.extend({_albumIDError:null,_albumIDs:[],_maxAlbums:0,_systemNotification:null,init:function(b,e){this._super();this._albumIDs=b;this._maxAlbums=e;this._albumIDError=null;var c=$('<span class="icon icon16 icon-refresh pointer jsTooltip galleryOverwriteIcon" title="'+WCF.Language.get("gallery.image.button.overwrite")+'" />').click($.proxy(this._click,this));this._overwriteIcons.push(c);var d=$("#albumID").parent().prev("dt");d.children("label").css("display","inline-block");d.append(c);if(!this._albumIDs.length){$("#albumID").hide();for(var a in this._overwriteIcons){this._overwriteIcons[a].hide()}}if(b.length<e){this._albumDialog=new Gallery.Album.Dialog();this._albumDialog.registerCallback("created",$.proxy(this._addNewAlbum,this));this._albumAddIcon=$('<span class="icon icon 16 icon-plus pointer jsTooltip" title="'+WCF.Language.get("gallery.album.button.add")+'" />').click($.proxy(this._addAlbum,this)).css("margin-left","5px");$("#albumID").after(this._albumAddIcon)}WCF.DOMNodeInsertedHandler.execute()},_addAlbum:function(a){this._albumDialog.show()},_addNewAlbum:function(b){this._albumIDs.push(b.albumID);if(this._albumIDs.length==1){$("#albumID").show();if($.getLength(this._imageHandler.getImages())>1){for(var a in this._overwriteIcons){this._overwriteIcons[a].show()}}}$("#albumID").append($('<option value="'+b.albumID+'" />').text(b.title)).val(b.albumID);if(this._albumIDs.length>=this._maxAlbums){this._albumAddIcon.remove();new WCF.System.Notification(WCF.Language.get("gallery.image.upload.albumLimitReached"),"warning").show(undefined,5000)}else{if(this._systemNotification===null){this._systemNotification=new WCF.System.Notification()}this._systemNotification.show()}},_click:function(a){a.preventDefault();if(this._needOverwriteConfirmation()){WCF.System.Confirmation.show(WCF.Language.get("gallery.image.albumID.overwrite.confirmMessage"),$.proxy(function(b){if(b==="confirm"){this._setAlbumID()}},this))}else{this._setAlbumID()}},_hideAlbumIDError:function(){if(this._albumIDError!==null){this._albumIDError.hide()}},_needOverwriteConfirmation:function(){var b=this.getImageHandler().getImages();for(var a in b){if(this.getImageHandler().getActiveImage().getImageID()==a){continue}if(b[a].get("albumID")){return true}}return false},_setAlbumID:function(){var b=this.getImageHandler().getImages();for(var a in b){if(this.getImageHandler().getActiveImage().getImageID()==a){continue}b[a].set("albumID",parseInt($("#albumID").val()||0))}new WCF.System.Notification().show()},_showAlbumIDError:function(a){if(this._albumIDError===null){this._albumIDError=$('<small class="innerError" />').hide();$("#albumID").after(this._albumIDError)}this._albumIDError.text(a).show()},_toggleOverwriteIcons:function(){if(!this._albumIDs.length){return}this._super()},readData:function(){this._data={albumID:parseInt($("#albumID").val()||0)}},updateData:function(){var a=this.getImageHandler().getActiveImage().getData();this._data={albumID:a.albumID||0};$("#albumID").val(this._data.albumID);var b=this.getImageHandler().getActiveImage().getErrors();if(b.albumID!==undefined){this._showAlbumIDError(b.albumID)}else{this._hideAlbumIDError()}},validateData:function(c){var b=c.getData();if(b.albumID){for(var a in b.albumID){if(this._albumIDs.indexOf(b.albumID[a])==-1){c.addError("albumID",WCF.Language.get("gallery.image.albumID.error.notValid"));return false}}}return true}});Gallery.Image.DataHandler.Tagging=Gallery.Image.DataHandler.Base.extend({_tagList:null,init:function(){this._super();this._readTagList();var a=$('<span class="icon icon16 icon-refresh pointer jsTooltip galleryOverwriteIcon" title="'+WCF.Language.get("gallery.image.button.overwrite")+'" />').click($.proxy(this._click,this));this._overwriteIcons.push(a);var b=$("#tagList").parent().prev("dt");b.children("label").css("display","inline-block").append(a)},_click:function(a){a.preventDefault();if(this._needOverwriteConfirmation()){WCF.System.Confirmation.show(WCF.Language.get("gallery.image.tags.overwrite.confirmMessage"),$.proxy(function(b){if(b==="confirm"){this._setTags()}},this))}else{this._setTags()}},_getTags:function(){var b=this._tagList.getTags();var a=this._tagList.getSearchInput().val();if(a&&b.indexOf(a)==-1){b.push(this._tagList.getSearchInput().val())}return b},_needOverwriteConfirmation:function(){var b=this.getImageHandler().getImages();for(var a in b){if(this.getImageHandler().getActiveImage().getImageID()==a){continue}$tags=b[a].get("tags");if($tags&&$tags.length){return true}}return false},_readTagList:function(){this._tagList=$("#tagList").data("__api")},_setTags:function(){var c=this._getTags();var b=this.getImageHandler().getImages();for(var a in b){if(this.getImageHandler().getActiveImage().getImageID()==a){continue}b[a].set("tags",c)}new WCF.System.Notification().show()},readData:function(){if(this._tagList===undefined){this._readTagList()}this._data={tags:this._getTags()}},updateData:function(){if(this._tagList===undefined){this._readTagList()}var a=this.getImageHandler().getActiveImage().getData();this._data={tags:a.tags||""};this._tagList.clearList();this._tagList.load(this._data.tags);this._tagList.getSearchInput().val("")}});Gallery.Image.DataHandler.Location=Gallery.Image.DataHandler.Base.extend({_locationInput:null,_useCoordinates:null,_userLatitude:null,_userLongitude:null,init:function(){this._super();this._locationInput=new WCF.Location.GoogleMaps.LocationInput("mapContainer",undefined,"#geocode",WCF.Location.GoogleMaps.Settings.get("defaultLatitude"),WCF.Location.GoogleMaps.Settings.get("defaultLongitude"));WCF.Location.Util.getLocation($.proxy(function(c,b){if(c!==undefined&&b!==undefined){this._userLatitude=c;this._userLongitude=b}},this));var a=$('<span class="icon icon16 icon-refresh pointer jsTooltip galleryOverwriteIcon" title="'+WCF.Language.get("gallery.image.button.overwrite")+'" />').click($.proxy(this._click,this));this._overwriteIcons.push(a);$("#mapContainer").parents("fieldset:eq(0)").children("legend").append(a);this._useCoordinates=$("#useCoordinates").change($.proxy(this._change,this))},_change:function(a){if(this._useCoordinates.prop("checked")){$(".jsCoordinatesField").show();this._locationInput.getMap().refresh()}else{$(".jsCoordinatesField").hide()}},_click:function(a){a.preventDefault();if(this._needOverwriteConfirmation()){WCF.System.Confirmation.show(WCF.Language.get("gallery.image.coordinates.overwrite.confirmMessage"),$.proxy(function(b){if(b==="confirm"){this._setCoordinates()}},this))}else{this._setCoordinates()}},_initLocation:function(b){if(b.get("latitude")!=0&&b.get("longitude")!=0&&!b.get("location")){var a=b.getImageID();WCF.Location.GoogleMaps.Util.reverseGeocoding($.proxy(function(c){if(c){var d=this.getImageHandler().getImage(a);d.set("__useCoordinates",true);d.set("location",c)}},this),null,b.get("latitude"),b.get("longitude"))}},_needOverwriteConfirmation:function(){var b=this.getImageHandler().getImages();for(var a in b){if(this.getImageHandler().getActiveImage().getImageID()==a){continue}if(b[a].get("latitude")!=0&&b[a].get("longitude")!=0){return true}}return false},_setCoordinates:function(){var d=WCF.Location.GoogleMaps.Util.getMarkerPosition(this._locationInput.getMarker());var e=this._useCoordinates.prop("checked");var b=this.getImageHandler().getImages();var f=$.trim($("#geocode").val());for(var a in b){if(this.getImageHandler().getActiveImage().getImageID()==a){continue}var c=b[a];c.set("latitude",d.latitude);c.set("location",f);c.set("longitude",d.longitude);c.set("__useCoordinates",e?1:0)}new WCF.System.Notification().show()},readData:function(){this._data=WCF.Location.GoogleMaps.Util.getMarkerPosition(this._locationInput.getMarker());this._data.location=$("#geocode").val();this._data.__useCoordinates=this._useCoordinates.prop("checked")?1:0},setImageHandler:function(a){this._super(a);this._imageHandler.registerCallback("addImage",$.proxy(this._initLocation,this))},updateData:function(){var a=this.getImageHandler().getActiveImage().getData();this._data={latitude:a.latitude||0,location:a.location||"",longitude:a.longitude||0,__useCoordinates:a.__useCoordinates!==undefined?a.__useCoordinates:(a.latitude!=0&&a.longitude!=0)};if(this._data.latitude!=0&&this._data.longitude!=0){WCF.Location.GoogleMaps.Util.moveMarker(this._locationInput.getMarker(),this._data.latitude,this._data.longitude,this._data.location?false:true)}else{if(this._userLatitude&&this._userLongitude){WCF.Location.GoogleMaps.Util.moveMarker(this._locationInput.getMarker(),this._userLatitude,this._userLongitude,true)}else{WCF.Location.GoogleMaps.Util.moveMarker(this._locationInput.getMarker(),WCF.Location.GoogleMaps.Settings.get("defaultLatitude"),WCF.Location.GoogleMaps.Settings.get("defaultLongitude"),true)}}WCF.Location.GoogleMaps.Util.focusMarker(this._locationInput.getMarker());this._useCoordinates.prop("checked",this._data.__useCoordinates?true:false);$("#geocode").val(this._data.location);this._change()}});Gallery.Image.PendingImageHandler=Class.extend({_imageHandler:null,init:function(a){this._imageHandler=a;$("#loadPendingImages").click($.proxy(this._loadImages,this));$("#deletePendingImages").click($.proxy(this._deleteImages,this))},_deleteImages:function(){WCF.System.Confirmation.show(WCF.Language.get("gallery.image.pendingImages.delete.confirmMessage"),$.proxy(function(a){if(a==="confirm"){new WCF.Action.Proxy({autoSend:true,data:{actionName:"deletePendingImages",className:"gallery\\data\\image\\ImageAction",parameters:{tmpHash:this._imageHandler.getTmpHash()}},success:$.proxy(this._success,this)})}},this))},_loadImages:function(){new WCF.Action.Proxy({autoSend:true,data:{actionName:"loadPendingImages",className:"gallery\\data\\image\\ImageAction",parameters:{tmpHash:this._imageHandler.getTmpHash()}},success:$.proxy(this._success,this)})},_success:function(c,d,b){switch(c.actionName){case"deletePendingImages":$("#thumbnailListContainer > fieldset > small").html(c.returnValues.limits);this._imageHandler.setUserImageCount(c.returnValues.userImageCount);break;case"loadPendingImages":if(c.returnValues){for(var a in c.returnValues){this._imageHandler.addImage(a,new Gallery.Image.Handler.Image(a,c.returnValues[a],null,true))}if(!this._imageHandler.getActiveImage()){this._imageHandler.setFirstImageActive()}}break}new WCF.System.Notification().show();$("#pendingImageContainer").remove()}});Gallery.Image.ThumbnailAreaSelector=Class.extend({_buttonList:null,_description:null,_imageDimensions:{},_imageDiv:null,_imageHandler:null,_selection:null,init:function(c){this._imageHandler=c;this._description=$("#image").next("small");this._overlay=$("#galleryThumbnailAreaSelectorOverlay");if(!this._overlay.length){this._overlay=$('<div id="galleryThumbnailAreaSelectorOverlay" class="dialogOverlay" />').css({height:"100%",zIndex:399}).hide().appendTo(document.body)}this._imageDiv=$("<div />").css({overflow:"hidden",position:"absolute",zIndex:400}).hide().click($.proxy(function(d){if(this._selection.draggable("option","disabled")){this._click(d)}},this)).appendTo(document.body);this._selection=$('<div id="galleryImageThumbnailAreaSelector" />').appendTo(this._imageDiv).resizable({aspectRatio:true,containment:"parent",handles:"n, e, s, w, ne, se, sw, nw",resize:$.proxy(this._updateSelection,this)}).draggable({containment:"parent",drag:$.proxy(this._updateSelection,this)});this._selection.append($('<div class="galleryImageThumbnailArea" />'));this._buttonList=$('<ul id="galleryImageThumbnailAreaButtons" class="buttonList smallButtons" />').hide().appendTo(document.body);var a=$("<li />").appendTo(this._buttonList);$('<span class="button buttonPrimary small" />').text(WCF.Language.get("gallery.image.thumbnail.chooseSelection")).click($.proxy(this._saveArea,this)).appendTo(a);var b=$("<li />").appendTo(this._buttonList);$('<span class="button small" />').text(WCF.Language.get("wcf.global.button.cancel")).click($.proxy(this._cancelSelection,this)).appendTo(b);$(window).resize($.proxy(this._resize,this))},_cancelSelection:function(){this._buttonList.hide();this._overlay.hide();var d=this._imageHandler.getActiveImage();if(d.get("thumbnailWidth")){var c=$("#image");var a=Math.ceil(d.get("thumbnailX")/d.get("width")*c.width());var b=Math.ceil(d.get("thumbnailY")/d.get("height")*c.height());this._selection.css({"background-position":"-"+a+"px -"+b+"px",height:Math.ceil(d.get("thumbnailHeight")*c.height()/d.get("height")),left:a,top:b,width:Math.ceil(d.get("thumbnailWidth")*c.width()/d.get("width"))});this._selection.draggable("option","disabled",true).resizable("option","disabled",true).addClass("disabled")}else{this._imageDiv.hide()}},_click:function(b){this.refresh(null,true);var a=$("#image > img");var c=this._imageHandler.getActiveImage();if(c.get("orientation")!=1){return}else{if(c.get("width")>1200&&c.get("height")>900){this._selection.resizable("option","minHeight",Math.floor(a.height()/c.get("height")*Math.min(c.get("height"),900)));this._selection.resizable("option","minWidth",Math.floor(a.width()/c.get("width")*Math.min(c.get("width"),1200)))}else{if(c.get("width")>560&&c.get("height")>420){this._selection.resizable("option","minHeight",Math.floor(a.height()/c.get("height")*Math.min(c.get("height"),420)));this._selection.resizable("option","minWidth",Math.floor(a.width()/c.get("width")*Math.min(c.get("width"),560)))}else{if(c.get("width")>280&&c.get("height")>210){this._selection.resizable("option","minHeight",Math.floor(a.height()/c.get("height")*Math.min(c.get("height"),420)));this._selection.resizable("option","minWidth",Math.floor(a.width()/c.get("width")*Math.min(c.get("width"),210)))}else{return}}}}this._buttonList.show();this._overlay.show();this._imageDiv.show();this._selection.draggable("option","disabled",false).resizable("option","disabled",false).removeClass("disabled");this._imageDiv.css("z-index",400)},_resize:function(){var c=$("#image > img");var a=c.getDimensions();if(this._selection.is(":visible")){var e=a.height/this._imageDimensions.height;var d=a.width/this._imageDimensions.width;this._selection.height(this._selection.height()*e);this._selection.width(this._selection.width()*d);this._imageDiv.height(this._imageDiv.height()*e);this._imageDiv.width(this._imageDiv.width()*d);var b=c.offset();this._imageDiv.css({left:b.left,top:b.top});this._selection.css("background-size",a.width+"px "+a.height+"px")}this._imageDimensions=a},_saveArea:function(){var c=this._imageHandler.getActiveImage();var b=$("#image > img");var a=this._selection.position();c.set("__selectionOutherHeight",this._selection.outerHeight());c.set("__selectionOutherWidth",this._selection.outerWidth());c.set("__selectionLeft",a.left);c.set("__selectionTop",a.top);c.set("thumbnailHeight",Math.ceil(this._selection.outerHeight()/b.height()*c.get("height")));c.set("thumbnailWidth",Math.ceil(this._selection.outerWidth()/b.width()*c.get("width")));c.set("thumbnailX",Math.ceil(a.left*c.get("width")/b.width()));c.set("thumbnailY",Math.ceil(a.top*c.get("height")/b.height()));if(c.get("thumbnailWidth")+c.get("thumbnailX")>c.get("width")){c.set("thumbnailWidth",c.get("width")-c.get("thumbnailX"))}if(c.get("thumbnailHeight")+c.get("thumbnailY")>c.get("height")){c.set("thumbnailHeight",c.get("height")-c.get("thumbnailY"))}this._buttonList.hide();this._overlay.hide();this._selection.draggable("option","disabled",true).resizable("option","disabled",true).addClass("disabled");this._selection.parent().css({"background-color":"rgba(0, 0, 0, 0.5)"});this._imageDiv.css("z-index",0)},_updateSelection:function(a,b){this._selection.css({"background-position":"-"+b.position.left+"px -"+b.position.top+"px"})},refresh:function(b,a){var d=$("#image > img");var e=this._imageHandler.getActiveImage();if(e.get("width")<=280&&e.get("height")<=210){this._selection.hide();this._description.hide();return}this._description.show();var i=d.offset();this._imageDiv.css({height:d.height(),left:i.left,top:i.top,width:d.width()});if(e.get("orientation")!=1){this._selection.hide();this._selection.parent().css({"background-color":"transparent"})}else{if(e.get("thumbnailWidth")||a){var f=this._imageDiv.height();var g=this._imageDiv.width();var h=0;var c=0;if(e.get("thumbnailWidth")){if(e.get("__selectionOutherWidth")){f=e.get("__selectionOutherHeight");g=e.get("__selectionOutherWidth");h=e.get("__selectionLeft");c=e.get("__selectionTop")}else{f=Math.ceil(e.get("thumbnailHeight")*d.height()/e.get("height"));g=Math.ceil(e.get("thumbnailWidth")*d.width()/e.get("width"));h=Math.ceil(e.get("thumbnailX")/e.get("width")*d.width());c=Math.ceil(e.get("thumbnailY")/e.get("height")*d.height())}}else{if(f/g<3/4){g=parseInt(f*4/3);h=parseInt((this._imageDiv.width()-g)/2)}else{f=parseInt(g*3/4);c=parseInt((this._imageDiv.height()-f)/2)}}this._selection.css({"background-image":"url("+d.attr("src")+")","background-position":"-"+h+"px -"+c+"px","background-size":this._imageDiv.width()+"px "+this._imageDiv.height()+"px",height:f,left:h,top:c,width:g});this._selection.show();this._selection.parent().css({"background-color":"rgba(0, 0, 0, 0.5)"})}else{this._selection.hide();this._selection.parent().css({"background-color":"transparent"})}}this._imageDimensions=$("#image > img").getDimensions()}});Gallery.Map={};Gallery.Map.LargeMap=WCF.Location.GoogleMaps.LargeMap.extend({_success:function(c,f,b){if(c.returnValues&&c.returnValues.markers){for(var e=0,d=c.returnValues.markers.length;e<d;e++){var a=c.returnValues.markers[e];this.addMarker(a.latitude,a.longitude,a.title,null,a.infoWindow,a.dialog,a.location);if(a.objectID){this._objectIDs.push(a.objectID)}else{if(a.objectIDs){this._objectIDs=this._objectIDs.concat(a.objectIDs)}}}}},addMarker:function(c,a,e,d,f,b,g){var h=$(f).get(0);var i=this._super(c,a,e,d,h);if(b){google.maps.event.addListener(i.infoWindow,"domready",$.proxy(function(){new Gallery.Map.InfoWindowImageListDialog($(h).find(".jsGalleryLocationDialogImageListButton"),b,g)},this))}return i.infoWindow}});Gallery.Map.InfoWindowImageListDialog=Class.extend({_dialog:null,_dialogContent:"",_imageData:[],init:function(b,c,a){this._dialogContent=c;this._location=a;b.click($.proxy(this._click,this))},_click:function(){if(this._dialog===null){this._dialog=$("<div />").append(this._dialogContent).hide().appendTo(document.body).wcfDialog({title:WCF.Language.get(this._location)})}else{this._dialog.wcfDialog("open")}}});